---
title: "Top-down systems biology workflow automation with KEGGscape and py2cytoscape"
author: "Kozo Nishida and Keiichiro Ono"
date: "April 3, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Note about this RMarkdown
This RMarkdown uses **Python3**, and needs R "reticulate" package.
Please run
```
install.packages("reticulate")
```
in your R shell before running this RMarkdown.

## Overview

This is an automation application of KEGGscape REST API to top-down systems biology approach.
FigureXXX is the workflow.

![top-down systems biology approach workflow](figures/fig1.png)

## Step 0 (Installing dependent packages)
First of all we install the R and Python packages for this workflow.

### Installing R packages

```
source("https://bioconductor.org/biocLite.R")

biocLite("ecoliLeucine")
biocLite("affy")
biocLite("limma")
```

### Installing Python packages

#### Mac or Linux

```
import os
os.system('python -m pip install py2cytoscape')
```

#### Windows

Windows users need to download and install the python-igraph whl from [Christophâ€™s site](http://www.lfd.uci.edu/~gohlke/pythonlibs/#python-igraph).
Please install python-igraph before you install py2cytoscape, otherwise pip will try to **build** python-igraph (and will fail). 

```
python -m pip install ".\python_igraph-0.7.1.post6-cp36-cp36m-win_amd64.whl"
python -m pip install py2cytoscape
```

## Step 1 (Microarray preprocessing)
We use bioconductor **ecoliLeucine and affy** packages for the dataset preprocessing of this workflow.
**ecoliLeucine** package is ...
eset is ...

```
library(ecoliLeucine)
library(affy)

data(ecoliLeucine)
eset <- rma(ecoliLeucine)
pData(eset)
```

## Step 2 (Statistical analysis)

We use bioconductor **limma** package for statistical analysis of ...

```
library(limma)
strain <- c("lrp-","lrp-","lrp-","lrp-","lrp+","lrp+","lrp+","lrp+")
design <- model.matrix(~factor(strain))
colnames(design) <- c("lrp-","lrp+vs-")
design

fit <- lmFit(eset, design)
fit <- eBayes(fit)
options(digits=2)
result <- topTable(fit, coef = 2, number = 40, adjust.method = "BH")
result
write.csv(result, file = "result.csv")
```

## Step 3 (Visualization with Cytoscape)

### Importing all Escherichia coli K-12 MG1655 KEGG pathways with KEGGscape REST API

```
import requests
import pandas as pd
from io import SrtingIO

r = requests.get('http://rest.kegg.jp/list/pathway/eco')
ecopathways = pd.read_table(StringIO(r.text), header=None)
for pathid in ecopathways[0]:
    requests.get('http://localhost:1234/keggscape/v1/' + i[5:])
```

### Importing the limma result table with py2cytoscape

#### Preprocessing of the limma statistical analysis result

```
limma = pd.read_csv("./result.csv", index_col=0)
new_index = limma.index.str.extract('(b[0-9]{4})', expand=None)
limma = limma.set_index(new_index)
limma = limma[limma.index.notna()]
```

#### Merge the limma result in Cytoscape

```
from py2cytoscape.data.cyrest_client import CyRestClient
cy = CyRestClient()
all_suid = cy.network.get_all()

for i in all_suid:
    net = cy.network.create(i)
    table = net.get_node_table()
    keggids = table['KEGG_ID']
    genes = keggids.str.extractall('(b[0-9]{4})')
    table4cy = pd.merge(genes, limma, left_on=0, right_index=True)
    if(table4cy.shape[0] != 0):
        #pathwayinfo = net.get_network_table()['KEGG_PATHWAY_ID']
        meantable4cy = table4cy.groupby('SUID').mean()
        net.update_node_table(df=meantable4cy, network_key_col='SUID')

```

#### Vizual Mapping of the limma result in Cytocape


## Step 4 (Data integration and knowledge discovery)
